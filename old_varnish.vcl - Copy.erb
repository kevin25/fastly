sub vcl_recv {

    if (req.http.Cookie ~ "WebSiteLang=") {
            #unset all the cookie from request except language
            set req.http.Language = regsub(req.http.Cookie, "(?:^|;\s*)(?:WebSiteLang=(.*?))(?:;|$)", "\1.");
        } elseif (!req.http.Cookie) {
            set req.http.Language = "fr";
        }
    # Forward client's IP to backend
    remove req.http.X-Forwarded-For;
    set req.http.X-Forwarded-For = client.ip;

    # Set the URI of your system directory
    if (req.url ~ "^/system/" ||
        req.url ~ "ACT=" ||
        req.request == "POST" ||
        (req.url ~ "member_box" && req.http.Cookie ~ "exp_sessionid"))
    {
        return (pass);
    }

    #unset req.http.Cookie;

    set req.grace = 1h;

    return(lookup);
}

sub vcl_fetch {

   #if (!beresp.http.set-Cookie ~ "WebSiteLang="){
   #     unset beresp.http.set-cookie;
   #}

    # Enable ESI includes
    #set beresp.do_esi = true;

    # Our cache TTL
    set beresp.ttl = 10m;

    set beresp.grace = 1h;

    return(deliver);

}

sub vcl_deliver {

    if (req.http.X-Varnish-Accept-Language) {
        set resp.http.Set-Cookie = req.http.Language;
    }
        if (obj.hits > 0) {
                set resp.http.X-Cache = "HIT";
        } else {
                set resp.http.X-Cache = "MISS";
        }
}


sub vcl_hash {
     set req.hash += req.url;
    if (req.http.host) {
    set req.hash += req.http.host;
        #hash_data(req.http.host);
    } else {
    set req.hash += server.ip;
        #hash_data(server.ip);
    }
    if (req.http.Language) {
        #add cookie in hash
    set req.hash += req.http.Language;
        #hash_data(req.http.Cookie);

    }
    return(hash);
}
